var timer=null;function hideError(){if(timer!=null){window.clearTimeout(timer)}timer=window.setTimeout(function(){$(".error-holder").fadeOut()
},5000)}function showPopup(c,a,b){if(b){$(".error-holder").addClass("error-holder-success")
}else{$(".error-holder").removeClass("error-holder-success")}$(".error-holder").css({top:""+a+"px","z-index":"999999"});
$(".error-holder span").text(c);$(".error-holder").fadeIn(function(){hideError()})
}function showError(b,a){showPopup(b,a,false)}function showSuccess(b,a){showPopup(b,a,true)
}$(document).ready(function(){$(".error-holder").on("click",function(){$(this).fadeOut()
})});(function(a){a.fn.makemediadescription=function(k){var b=a(this);var k=a.extend({insidedescription:""},k);
var e=k.insidedescription;b.append('<div contenteditable="true" class="article-description">'+e+"</div>");
var c=new Date();c=c.getTime();a("body").append('<div class="md-menu-panel" id="'+c+'"><div class="mitem adescr-reset"></div><div class="mitem adescr-bold"></div><div class="mitem adescr-italic"></div><div class="mitem adescr-h2">H2</div><div class="mitem adescr-h3">H3</div><div class="mitem bitem adescr-h4">H4</div><div class="mitem adescr-centered"></div><div class="mitem adescr-strong"></div><div class="mitem adescr-addlink"></div><div class="link-holder"><span class="open-link"></span><input class="href-val" type="text"></div></div>');
var f=a("#"+c);var g=b.find(".article-description");g.attr("id","article-descr-"+c);
a.textHighlighter.createWrapper=function(){return a('<span class="temp"></span>')
};g.textHighlighter();function j(l){if(f.find(".link-holder:visible").length){f.find(".link-holder").hide();
f.find(".mitem").show()}if(b.find(".temp").length&&(l=="first")){var n=(b.find(".temp").offset().top)-46;
var m=b.find(".temp").offset().left;f.css({top:n,left:m}).fadeIn("fast")}else{if(a(".md-menu-panel:visible").length&&(l=="change")){if(b.find(".temp").length){var n=b.find(".temp").offset().top-46;
var m=b.find(".temp").offset().left;f.css({top:n,left:m})}else{f.fadeOut("fast")}}else{f.fadeOut("fast")
}}}a(document).on("scroll",function(){j("change")});g.on("scroll",function(){j("change")
});b.on("mouseup",function(){j("first")});f.on("click",".mitem",function(){if(!a(this).hasClass("adescr-addlink")){j("hide")
}});b.on("keydown",function(l){i(l,a(this))});b.on("keypress",function(l){i(l,a(this))
});function i(p,o){if((p.keyCode==8)||(p.keyCode==46)){if(o.find(".temp").length>0){p.preventDefault();
o.find(".temp").first().before('<span id="cursorpos"></span>');var n=document.getElementById("cursorpos");
var l=document.createRange();l.setStartAfter(n);l.collapse(true);var m=window.getSelection();
m.removeAllRanges();m.addRange(l);o.find(".temp").remove();o.find("#cursorpos").remove();
a("p:empty").remove();a("span:empty").remove();a("h2:empty").remove();a("h3:empty").remove();
a("h4:empty").remove();a("a:empty").remove()}}}b.on("mousedown",g,function(){b.find(".temp").each(function(){a(this).contents().unwrap()
})});function d(m,p){var o="";var l=0;var n=b.find(".temp").length;b.find(".temp").each(function(){l++;
o=o+a(this).text();if((m=="a")&&(a(this).parent().is("a"))){a(this).unwrap()}if(l==n){if(p!=""){if(m=="span"){var s=a(this).after("<"+m+' class="'+p+'">'+o+"</"+m+">")
}else{if(m=="a"){var q;if(f.find(".open-link").hasClass("active")){q=a(this).after("<"+m+'  href="'+p+'" target="_blank">'+o+"</"+m+">")
}else{q=a(this).after("<"+m+'  href="'+p+'" rel="nofollow" target="_blank">'+o+"</"+m+">")
}if(q.parent().is("a")){q.unwrap()}}}}else{var r=a(this).after("<"+m+">"+o+"</"+m+">");
if(r.parent().attr("id")!=g.attr("id")){r.unwrap()}}}a(this).remove()})}f.on("click",".adescr-bold",function(){d("b","")
});f.on("click",".adescr-italic",function(){d("i","")});f.on("click",".adescr-h2",function(){d("h2","")
});f.on("click",".adescr-h3",function(){d("h3","")});f.on("click",".adescr-h4",function(){d("h4","")
});f.on("click",".adescr-strong",function(){d("strong","")});f.on("click",".adescr-centered",function(){d("span","a-centered")
});f.on("click",".adescr-reset",function(){b.find(".temp").each(function(){if(a(this).parent().attr("id")!=g.attr("id")){a(this).unwrap()
}})});f.on("click",".adescr-addlink",function(){a(this).siblings().fadeOut("fast");
a(this).fadeOut("fast",function(){a(this).next().fadeIn("fast");a(".href-val").focus()
})});f.on("keyup",".href-val",function(m){if(m.keyCode==13){if(a(this).val()!=""){var l=a(this).val();
d("a",l)}a(this).val("");a(this).parent().fadeOut("fast",function(){f.find(".mitem").fadeIn("fast");
f.find(".open-link").removeClass("active")})}});f.on("click",".open-link",function(){a(this).toggleClass("active");
f.find(".href-val").focus()});function h(){g.find("br").each(function(){if((a(this).parent().is("div"))&&(a(this).parent().attr("id"))!=g.attr("id")){a(this).unwrap()
}});g.find(".temp").each(function(){a(this).contents().unwrap()});g.find("div").each(function(){if(a(this).text().length==0){a(this).remove()
}else{a(this).before("<br>");a(this).contents().unwrap()}});g.find("h2:empty").remove();
g.find("h3:empty").remove();g.find("h4:empty").remove();g.find("a:empty").remove();
var l=g.html().replace(/&nbsp;/g,"");return l}return{destroyPluginEvent:function(){b.children().die();
f.children.die()},saveDescription:function(){return h()}};return b}})(jQuery);$(document).ready(function(){$("body").on("focus","#alias",function(){if($(this).val()==""){var a=$("#title").val();
a=a.replace(/ /g,"-").toLowerCase();a=a.replace(/\./g,"-");a=a.replace(/:/g,"");a=a.replace(/,/g,"");
a=a.replace(/;/g,"");a=a.replace(/а/g,"a");a=a.replace(/б/g,"b");a=a.replace(/в/g,"v");
a=a.replace(/г/g,"g");a=a.replace(/д/g,"d");a=a.replace(/е/g,"e");a=a.replace(/ё/g,"yo");
a=a.replace(/ж/g,"j");a=a.replace(/з/g,"z");a=a.replace(/и/g,"i");a=a.replace(/й/g,"i");
a=a.replace(/к/g,"k");a=a.replace(/л/g,"l");a=a.replace(/м/g,"m");a=a.replace(/н/g,"n");
a=a.replace(/о/g,"o");a=a.replace(/п/g,"p");a=a.replace(/р/g,"r");a=a.replace(/с/g,"s");
a=a.replace(/т/g,"t");a=a.replace(/у/g,"u");a=a.replace(/ф/g,"f");a=a.replace(/х/g,"h");
a=a.replace(/ц/g,"c");a=a.replace(/ч/g,"ch");a=a.replace(/ш/g,"sh");a=a.replace(/щ/g,"sch");
a=a.replace(/ъ/g,"");a=a.replace(/ы/g,"y");a=a.replace(/ь/g,"");a=a.replace(/э/g,"e");
a=a.replace(/ю/g,"yu");a=a.replace(/я/g,"ya");$(this).val(a)}})});$(document).ready(function(){$("body").on("click",".p-cancel",function(){$(".popup-holder.dynamic").fadeOut("fast",function(){$(this).remove()
})});$("body").on("click",".checker",function(){$(this).toggleClass("active");var a=$(this).attr("data-relna");
if(a){$("."+a).toggleClass("na")}});$(".check-holder").on("click",".check",function(){if(!$(this).parent(".check-holder").hasClass("na")){if($(this).parents(".check-holder").hasClass("single")){$(this).parents(".check-holder").find(".check").removeClass("active");
$(this).addClass("active")}else{$(this).toggleClass("active")}}});$("body").on("click",".open-bayan",function(){if($(this).hasClass("up")){$(this).next().slideUp("fast");
$(this).removeClass("up")}else{$(this).addClass("up");$(this).next().slideDown("fast")
}})});function tagMeBabe(g,e,c,f,b,h){var d=50;function i(j){j=j.trim().toLowerCase();
var k=true;g.val("");f.find("."+b).each(function(){if($(this).text()==j){$(this).addClass("double");
k=false}else{$(this).removeClass("double")}});if(k){f.prepend('<div class="'+b+'">'+j+"</div>")
}}function a(j){if(j.val().length>1){var k={};k.key=j.val();k.action="searchtag";
$.ajax({url:h,type:"POST",dataType:"json",data:k,error:function(){showError("Ошибка базы данных!",d)
}}).done(function(m){e.children().remove();for(var l=0;l<m.result.length;l++){e.append("<span>"+m.result[l].name+"</span>")
}if(e.children().length>0){e.slideDown(200)}else{e.slideUp(10)}})}}g.on("focus",function(){a($(this))
});g.on("keyup",function(l){var j=$(this).val();var k=$(this);if(l.keyCode==40){if(e.find(".active").length>0){e.find(".active").removeClass("active").next().addClass("active")
}else{e.find("span:first").addClass("active")}k.val(e.find(".active").text())}else{if(l.keyCode==38){if(e.find(".active").length>0){e.find(".active").removeClass("active").prev().addClass("active")
}else{e.find("span:last").addClass("active")}k.val(e.find(".active").text())}else{if(l.keyCode==13){i(j);
e.slideUp(10)}else{a(k)}}}});f.on("click","."+b,function(){$(this).fadeOut(100,function(){$(this).remove()
})});e.on("click","span",function(){i($(this).text());e.slideUp(10)});$(document).mousedown(function(j){if(!$(j.target).is("span")&&(!$(j.target).parent().hasClass(c))){e.slideUp(10,function(){e.children().remove()
})}})}var globalArticleMainImageFileNameToUpload=null;var mediaElement=null;var errorTopMargin=50;
function uploadMainArticleImg(b){globalArticleMainImageFileNameToUpload=b;if(b!=undefined){if(!b.type.match("image.*")){showError("File type should be an image",errorTopMargin);
return}var a=new FileReader();a.onload=(function(){return function(c){if($(".logo-holder.imgarticle img").length){$(".logo-holder.imgarticle img").fadeOut("fast",function(){$(".logo-holder.imgarticle").append('<img src="'+c.target.result+'">');
$(this).remove()})}else{$(".logo-holder.imgarticle").append('<img src="'+c.target.result+'">')
}}})(b);a.readAsDataURL(b)}}$(document).ready(function(){$("body").on("click","#main-article-img",function(){$("#imgarticle").click()
});$("body").on("change","#imgarticle",function(d){var c=d.target.files;var b=c[0];
uploadMainArticleImg(b)});$("#del-main-img").on("click",function(){if($(".logo-holder img").length&&($(".logo-holder img").attr("src").indexOf("noimage")==-1)){$(".logo-holder img").fadeOut("fast",function(){globalArticleMainImageFileNameToUpload=null;
$("#edit-article").addClass("todelete").attr("data-src",$(this).attr("src"));$(this).remove()
});$(".logo-holder").append('<img src="/images/noimage-slide.jpg" alt="noimage" />')
}});if($(".mediaelement").length){var a=$(".mediaelement").find(".mediacontent").html();
mediaElement=$(".mediaelement").makemediadescription({insidedescription:a});window.onbeforeunload=function(){if(!$("#deleted").length){return"Ты сохранил все изменения?"
}}}});$(document).ready(function(){var a=50;$("#search-article").on("keyup",function(j){if($(this).val().length>1){var i={};
i.key=$(this).val();i.action="searcharticle";i.catid=window.location.href.substr(window.location.href.lastIndexOf("/")+1);
$.ajax({url:"/admin/articles",type:"POST",dataType:"json",data:i,error:function(){showError("Ошибка базы данных!",a)
}}).done(function(k){$(".articles").children().remove();$(".articles").append(k.result);
if(k.result.length==0){$(".articles").append('<div class="notfound">Ой... Похоже ничего не найдено!</div>')
}})}});if($("#tags").length){var c=$("#tags");var e=$(".autofill-bar");var d="autofill-bar";
var g=$("#article-tags");var b="t-item";var h="/admin/article";tagMeBabe(c,e,d,g,b,h)
}function f(k,j){if(!j.hasClass("working")){var o=$(".id-info").attr("data-lang");
if(($("#article-categories .active").length>0)||(o!="default")){if($("#title").val().length==0){showError("Введите название статьи!",a)
}else{if((o=="default")&&($("#alias").val().length==0)){showError("Введите URL статьи!",a)
}else{j.addClass("working");var l={};l.action=k;if(k=="editarticle"){l.id=$(".id-info").attr("id")
}l.title=$("#title").val();l.alias=$("#alias").val();l.shortdescription=$("#shortdescription").val();
l.htmltitle=$("#htmltitle").val();l.htmldescription=$("#htmldescription").val();l.htmlkeywords=$("#htmlkeywords").val();
l.moderator=$("#moderator").text();l.parent=$(".id-info").attr("data-parent");l.lang=o;
var n=[];$("#article-categories .active").each(function(){n.push($(this).attr("id"))
});l.categories=n;var i=[];$("#article-tags .t-item").each(function(){i.push($(this).text())
});l.tags=i;l.description=mediaElement.saveDescription();$(".loader").fadeIn("fast");
$.ajax({url:"/admin/article/",type:"POST",dataType:"json",data:l,error:function(p){showError(p.responseText,a);
j.removeClass("working");$(".loader").fadeOut("fast")}}).done(function(r){var p=r.id;
if(globalArticleMainImageFileNameToUpload){var q=new FormData();q.append("fileUpload",globalArticleMainImageFileNameToUpload);
q.append("action","savemainimage");q.append("id",p);var s=new XMLHttpRequest();s.open("post","/admin/article/",true);
s.send(q);s.onreadystatechange=function(){if(this.readyState==4){if(s.responseText!="Success"){showError(s.responseText,a);
j.removeClass("working");$(".loader").fadeOut("fast")}else{m()}}}}else{m()}});function m(){j.removeClass("working");
$(".loader").fadeOut("fast");var p=window.location.href;p=p.substr(0,p.lastIndexOf("/"));
if($(".id-info").attr("data-lang")=="default"){p=p.replace("article","articles")}window.location.href=p
}}}}else{showError("Выберите хотя бы одну категорию!",a)}}}$("#edit-article").on("click",function(){var i=$(this);
if(i.hasClass("todelete")){var j={};j.id=$(".id-info").attr("id");j.action="deletemainimg";
j.file=".."+i.attr("data-src");$.ajax({url:"/admin/article/",type:"POST",dataType:"json",data:j,error:function(k){showError(k.responseText,a)
}}).done(function(){f("editarticle",i)})}f("editarticle",i)});$("#new-article").on("click",function(){var i=$(this);
f("newarticle",i)});$("#delete-article").on("click",function(){$("body").append('<div class="popup-holder dynamic"><div class="popup-content" style="height: 200px; width: 600px; margin-left: -300px; margin-top: -100px;"><div class="popup-header">Удаление статьи</div><div class="full">Вы действительно хотите удалить статью '+$("#title").val()+'?</div><div class="clear centered"><div class="button green" id="yes-delete-article">Удалить</div><div class="button grey p-cancel">Отмена</div></div></div></div>');
$(".popup-holder.dynamic").fadeIn()});$("body").on("click","#yes-delete-article",function(){var i=$(this);
if(!i.hasClass("working")){i.addClass("working");var j={};j.action="deletearticle";
j.id=$(".id-info").attr("id");$.ajax({url:"/admin/article",type:"POST",dataType:"json",data:j,error:function(){showError("Невозможно удалить статью!",a);
i.removeClass("working")}}).done(function(l){window.location.href="/admin/categories";
var k=window.location.href;k=k.substr(0,k.lastIndexOf("/"));if($(".id-info").attr("data-lang")=="default"){$(".id-info").attr("id","deleted");
k="/admin/categories"}window.location.href=k})}});$(".articles").on("click",".published span",function(){var j=$(this);
var k={};var i="yes";if(j.hasClass("yes")){i="no"}k.flag=i;k.id=j.parent().parent().attr("id");
k.action="setpublished";$.ajax({url:"/admin/article/",type:"POST",dataType:"json",data:k,error:function(){showError("Ошибка базы данных",a)
}}).done(function(){if(i=="yes"){j.removeClass("no").addClass("yes").text("Опубликована");
showSuccess("Статья опубликована",a)}else{j.removeClass("yes").addClass("no").text("Не опубликована");
showSuccess("Статья снята с публикации",a)}})})});$(document).ready(function(){var a=50;
$("#b-new-category").on("click",function(){$("body").append('<div class="popup-holder dynamic"><div class="popup-content" style="height: 300px; width: 600px; margin-left: -300px; margin-top: -150px;"><div class="popup-header">Создать новую категорию</div><div class="full"><label for="title">Заголовок категории</label><input type="text" id="title"><label for="alias">URL (без домена и /)</label><input type="text" id="alias"></div><div class="clear centered"><div class="button green" id="save-category">Сохранить</div><div class="button grey p-cancel">Отмена</div></div></div></div>');
$(".popup-holder.dynamic").fadeIn()});$("body").on("click","#save-category",function(){var c=$(this);
if(!c.hasClass("working")){c.addClass("working");var d={};d.title=$("#title").val();
d.alias=$("#alias").val();d.pos=$("#sortable li").length;d.action="newcategory";d.moderator=$("#moderator").text();
if(d.title.length==0){showError("Пожалуйста введите заголовок категории!",a);c.removeClass("working")
}else{if(d.alias.length==0){showError("Пожалуйста введите роут!",a);c.removeClass("working")
}else{$.ajax({url:"/admin/categories",type:"POST",dataType:"json",data:d,error:function(e){showError(e.responseText,a);
c.removeClass("working")}}).done(function(e){c.removeClass("working");$(".popup-holder.dynamic").fadeOut("fast",function(){$(this).remove()
});$("#sortable").append(e.result)})}}}});function b(){$(".ui-sortable-handle").each(function(){var c={};
c.pos=$(this).prevAll().length;c.id=$(this).attr("id");c.action="posupdate";$.ajax({url:"/admin/categories",type:"POST",dataType:"json",data:c})
})}if($("#sortable").length){$("#sortable").sortable({deactivate:function(){b()},placeholder:"ui-state-highlight"});
$("#sortable").disableSelection()}$("#delete-category").on("click",function(){$("body").append('<div class="popup-holder dynamic"><div class="popup-content" style="height: 200px; width: 600px; margin-left: -300px; margin-top: -100px;"><div class="popup-header">Удаление категории</div><div class="full">Вы действительно хотите удалить категорию '+$("#title").val()+'?</div><div class="clear centered"><div class="button green" id="yes-delete-category">Удалить</div><div class="button grey p-cancel">Отмена</div></div></div></div>');
$(".popup-holder.dynamic").fadeIn()});$("body").on("click","#yes-delete-category",function(){var c=$(this);
if(!c.hasClass("working")){c.addClass("working");var d={};d.id=$(".id-info").attr("id");
d.action="deletecategory";$.ajax({url:"/admin/categories",type:"POST",dataType:"json",data:d,error:function(){showError("Невозможно удалить категорию!",a);
c.removeClass("working")}}).done(function(){$(".id-info").attr("id","deleted");window.location.href="/admin/categories"
})}});$("#edit-category").on("click",function(){var d=$(this);if(!d.hasClass("working")){d.addClass("working");
var e={};e.title=$("#title").val();e.shortdescription=$("#shortdescription").val();
e.htmltitle=$("#htmltitle").val();e.htmldescription=$("#htmldescription").val();e.htmlkeywords=$("#htmlkeywords").val();
e.alias=$("#alias").val();e.menutitle=$("#menutitle").val();e.moderator=$("#moderator").text();
var c="false";if($(".ismain").hasClass("active")){c="true"}e.ismain=c;e.description=mediaElement.saveDescription();
e.id=$(".id-info").attr("id");e.parent=$(".id-info").attr("data-parent");var f=$(".id-info").attr("data-lang");
e.lang=f;e.action="editcategory";$(".loader").fadeIn("fast");$.ajax({url:"/admin/categories",type:"POST",dataType:"json",data:e,error:function(g){showError(g.responseText,a);
d.removeClass("working");$(".loader").fadeOut("fast")}}).done(function(g){var h=g.id;
d.removeClass("working");$(".loader").fadeOut("fast");if($(".id-info").attr("data-lang")=="default"){if($(".crumbs").find("a").length){window.location.href=$(".crumbs").find("a").attr("href")
}else{window.location.href="/admin/categories"}}else{window.location.href=window.location.href.substr(0,window.location.href.lastIndexOf("/"))
}})}})});$(document).ready(function(){var b=50;var c=/^([a-zA-Z0-9_\-])+$/;var a=/^[a-zA-Z0-9!%&@#$\^*?_~+]+$/;
$("#pass").on("keyup",function(d){if(d.keyCode==13){$(".b-login").click()}});$(".b-login").on("click",function(){var d={};
d.username=$("#username").val();d.password=$("#pass").val();if(d.username==""){showError("Пожалуйста введите свое имя!",b)
}else{if(d.password==""){showError("Пожалуйста введите свой пароль!",b)}else{if(!c.test(d.username)){showError("Недопустимые символы в имени",b)
}else{if(!a.test(d.password)){showError("Недопустимые символы в пароле",b)}else{$.ajax({url:"/login",type:"POST",dataType:"json",data:d,error:function(){showError("Неверное имя или пароль!",b)
}}).done(function(e){if(e.link){window.location.href=e.link}else{showError("Неверное имя или пароль!",b)
}})}}}}})});